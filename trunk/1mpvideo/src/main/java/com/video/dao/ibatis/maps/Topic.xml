<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="Topic">
	<typeAlias alias="Topic" type="com.video.domain.Topic" />
	<resultMap id="Topic" class="Topic">
		<result property="id" column="id" />
		<result property="title" column="title" />
		<result property="text" column="text" />
		<result property="user.id" column="user_id" />
		<result property="group.id" column="group_id" />
		<result property="browseCount" column="browse_times" />
		<result property="flag" column="flag" />
		<result property="recommendDate" column="recommend_date" />
		<result property="addDate" column="add_date" />
	</resultMap>
	

<resultMap id="TopicList" class="Topic">
		<result property="id" column="id" />
		<result property="title" column="title" />
		<result property="text" column="text" />
		<result property="text2" column="text2" />
		<result property="browseCount" column="browse_times" />
		<result property="addDate" column="add_date" />
		<result property="recommendDate" column="recommend_date" />
	</resultMap>


	<resultMap id="TopicJoinMap" class="Topic" groupBy="id">
		<result property="id" column="t.id" />
		<result property="title" column="t.title" />
		<result property="text" column="t.text" />

		<result property="user.id" column="u.id" />
		<result property="user.userName" column="u.username" />
		<result property="group.id" column="g.id" />
		<result property="group.name" column="g.name" />
		<result property="browseCount" column="t.browse_times" />
		<result property="addDate" column="t.add_date" />
		<result property="flag" column="t.flag" />
		<result property="recommendDate" column="t.recommend_date" />
		<result property="comments" resultMap="topic.commentresult" />
	</resultMap>

	<resultMap id="TopicSimple" class="Topic">
	<result property="id" column="t.id" />
		<result property="title" column="t.title" />
		<result property="text" column="t.text" />
		<result property="user.id" column="u.id" />
		<result property="user.realName" column="u.realname" />
		<result property="user.face" column="u.face" />
		<result property="group.id" column="g.id" />
		<result property="group.name" column="g.name" />
		<result property="group.owner.id" column="g.user_id" />
		<result property="browseCount" column="t.browse_times" />
		<result property="addDate" column="t.add_date" />
		<result property="dailyId" column="t.daily_id" />
	</resultMap>

	<resultMap class="Topic" id="TopicJoin">
		<result property="id" column="t.id" />
		<result property="title" column="t.title" />
		<result property="text" column="t.text" />
		<result property="user.id" column="u.id" />
		<result property="user.realName" column="u.realname" />
		<result property="group.id" column="g.id" />
		<result property="group.name" column="g.name" />
		<result property="browseCount" column="t.browse_times" />
		<result property="addDate" column="t.add_date" />
		<result property="flag" column="t.flag" />
		<result property="recommendDate" column="t.recommend_date" />
		<result property="commentCount" column="commentcount" />

	</resultMap>
	<resultMap id="commentResult"
		class="com.video.domain.TopicComment">
	<result property="id" column="c.id" />
		<result property="comment" column="comment" />
		<result property="addDate" column="c.add_date" />
	</resultMap>

	<insert id="createTopic" parameterClass="Topic">
		insert into
		w_topices(title,text,text2,user_id,group_id,browse_times,add_date,flag,daily_id)
		values>(#title#,#text#,#text2#,#user.id#,#group.id#,0,#addDate#,1,#dailyId#)

		<selectKey keyProperty="id">select last_insert_id()</selectKey>
	</insert>


	<select id="countTopic" parameterClass="com.video.util.Pagination"
		resultClass="int">
		select count(*) from w_topices where flag !=0
		<isNotEmpty property="condition.title" prepend="and">
			title like #condition.title# escape '!'
		</isNotEmpty>
	</select>


	<select id="countTopicesByGroupId"
		parameterClass="com.video.util.Pagination" resultClass="int">
		select count(*) from w_topices WHERE FLAG !=0
		<isNotEmpty property="condition.id" prepend="and">
			group_id = #condition.id#
		</isNotEmpty>


	</select>


	<select id="getTopicesByGroupId"
		parameterClass="com.video.util.Pagination" resultMap="TopicJoin">

		select
		t.flag,t.recommend_date,t.id,t.title,t.text,t.add_date,t.browse_times,u.id,u.realname,g.id,g.name,count(c.id)
		commentcount from w_topices t left join users u on t.user_id =
		u.id left join

		w_groups g on t.group_id=g.id left join w_topic_comments c on
		t.id=c.topic_id where t.flag != 0
		<isNotEmpty property="condition.id" prepend="and">
			t.group_id = #condition.id#
		</isNotEmpty>


		group by t.id
		<isNotEmpty prepend="order by" property="orderFieldName">
			$orderFieldName$ DESC
		</isNotEmpty>

		limit #startIndex#,#size#

	</select>

	<select id="getTopices" parameterClass="com.video.util.Pagination"
		resultMap="TopicJoin">
		select
		t.flag,t.recommend_date,t.id,t.title,t.text,t.add_date,t.browse_times,u.id,u.realname,g.id,g.name,count(c.id)
		commentcount from w_topices t left join users u on t.user_id =
		u.id left join w_groups g on t.group_id=g.id left join
		w_topic_comments c on t.id=c.topic_id where t.flag != 0
		<isNotEmpty property="condition.title" prepend="and">
			t.title like #condition.title# escape '!'
		</isNotEmpty>


		group by t.id
		<isNotEmpty prepend="order by" property="orderFieldName">
			$orderFieldName$ DESC
		</isNotEmpty>
		limit #startIndex#,#size#

	</select>

	<select id="countMyGroupTopic"
		parameterClass="com.video.util.Pagination" resultClass="int">
		select count(*) from w_topices
		<dynamic prepend="where">
			<isNotEmpty property="condition.user.id" prepend="and">
				group_id in (select group_id from w_group_user where
				user_id = #condition.user.id#)
			</isNotEmpty>
		</dynamic>


	</select>
	<select id="getMyGroupTopices"
		parameterClass="com.video.util.Pagination" resultMap="TopicJoin">
		select
		t.flag,t.recommend_date,t.id,t.title,t.text,t.add_date,t.browse_times,u.id,u.realname,g.id,g.name,count(c.id)
		commentcount from w_topices t left join users u on t.user_id =
		u.id left join

		w_groups g on t.group_id=g.id left join w_topic_comments c on
		t.id=c.topic_id
		<dynamic prepend="where">
			<isNotEmpty property="condition.user.id" prepend="and">
				g.id in (select group_id from w_group_user where user_id
				= #condition.user.id#)
			</isNotEmpty>
		</dynamic>


		group by t.id
		<isNotEmpty prepend="order by" property="orderFieldName">
			$orderFieldName$ DESC
		</isNotEmpty>
		limit #startIndex#,#size#

	</select>


	<select id="getTopicById" parameterClass="java.lang.Long"
		resultMap="TopicSimple">
		select
		t.id,t.title,t.add_date,t.text,t.browse_times,t.daily_id,u.id,u.realname,u.face,g.id,g.name,g.user_id
		from w_topices t left join users u on t.user_id = u.id left join
		w_groups g on t.group_id = g.id where t.id = #value# and t.flag
		!=0
	</select>

	<delete id="deleteTopicById" parameterClass="java.lang.Long">
		delete from W_TOPICES where ID = #value#

	</delete>

	<delete id="deleteTopicByGroupId" parameterClass="java.lang.Long">
		delete from W_TOPICES where GROUP_ID = #value#

	</delete>

	<update id="updateTopic" parameterClass="Topic">
		update w_topices set
		title=#title#,text=#text#,text2=#text2#,browse_times=#browseCount#,
		add_date=#addDate#,recommend_date=#recommendDate# where id=#id#


	</update>
	
	<select id="getTopicesByDaily" parameterClass="java.lang.Long" resultMap="TopicList">
	select id,title,text,text2,browse_times,add_date,recommend_date from w_topices where daily_id= #value#
	
	</select>
	
	




</sqlMap>